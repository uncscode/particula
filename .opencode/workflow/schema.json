{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "https://adw.ai/workflow-schema.json",
  "title": "ADW Workflow Definition",
  "description": "JSON schema for ADW workflow definitions with agent steps and nested workflows",
  "type": "object",
  "required": ["name", "steps"],
  "properties": {
    "name": {
      "type": "string",
      "title": "Workflow Name",
      "description": "Unique identifier for the workflow definition",
      "minLength": 1,
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "description": {
      "type": "string",
      "title": "Workflow Description",
      "description": "Human-readable description of the workflow purpose and functionality",
      "default": ""
    },
    "description_long": {
      "type": "string",
      "title": "Detailed Workflow Description",
      "description": "Detailed workflow description for display in GitHub status comments"
    },
    "workflow_type": {
      "type": "string",
      "title": "Workflow Type",
      "description": "Workflow type for GitHub label management (complete, patch, document, generate, fix, custom)"
    },
    "trigger": {
      "type": "object",
      "title": "Workflow Trigger",
      "description": "Optional trigger metadata for automated invocation",
      "properties": {
        "label": {
          "type": "string",
          "title": "Trigger Label",
          "description": "Label required to trigger workflow execution",
          "minLength": 1
        },
        "exclude_draft": {
          "type": "boolean",
          "title": "Exclude Draft",
          "description": "Exclude draft pull requests from triggering",
          "default": false
        }
      },
      "required": ["label"],
      "additionalProperties": false
    },
    "on_failure": {
      "type": "object",
      "title": "Failure Handling",
      "description": "Optional metadata for failure handling (labels, comments)",
      "properties": {
        "labels": {
          "type": "array",
          "title": "Failure Labels",
          "description": "Labels to add when workflow fails",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "comment": {
          "type": "string",
          "title": "Failure Comment",
          "description": "Comment to post when workflow fails"
        }
      },
      "additionalProperties": false
    },
    "steps": {
      "type": "array",
      "title": "Workflow Steps",
      "description": "Ordered list of steps to execute in the workflow",
      "minItems": 1,
      "items": {
        "oneOf": [
          {
            "$ref": "#/definitions/AgentStep"
          },
          {
            "$ref": "#/definitions/WorkflowStep"
          }
        ]
      }
    }
  },
  "definitions": {
    "AgentStep": {
      "type": "object",
      "title": "Agent Execution Step",
      "description": "Step that executes an agent with a slash command or invokes an agent directly",
      "required": ["type", "name", "prompt"],
      "oneOf": [
        {
          "required": ["command"]
        },
        {
          "required": ["agent"]
        }
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "agent",
          "description": "Step type identifier for agent execution"
        },
        "name": {
          "type": "string",
          "title": "Step Name",
          "description": "Human-readable name for the step",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "title": "Step Description",
          "description": "Detailed step description for display in GitHub status comments"
        },
        "command": {
          "type": "string",
          "title": "Slash Command",
          "description": "Slash command to execute (e.g., '/plan', '/implement'). Provide either 'command' or 'agent', not both.",
          "pattern": "^/[a-zA-Z_][a-zA-Z0-9_]*$"
        },
        "agent": {
          "type": "string",
          "title": "Agent Name",
          "description": "Agent name for direct invocation (e.g., 'tester', 'implementor'). Provide either 'command' or 'agent', not both.",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_-]*$"
        },
        "prompt": {
          "type": "string",
          "title": "Agent Prompt",
          "description": "Prompt text to send to the agent for execution",
          "minLength": 1
        },
        "model": {
          "type": "string",
          "title": "Model Tier",
          "description": "Model tier to use for execution (light, base, heavy)",
          "enum": ["light", "base", "heavy"],
          "default": "base"
        },
        "timeout": {
          "type": "integer",
          "title": "Timeout",
          "description": "Maximum execution time in seconds (default: 600 = 10 minutes)",
          "minimum": 1,
          "default": 600
        },
        "retry": {
          "type": "object",
          "title": "Retry Configuration",
          "description": "Configuration for retry behavior with exponential backoff",
          "properties": {
            "max_retries": {
              "type": "integer",
              "title": "Max Retries",
              "description": "Maximum number of retry attempts (default: 3)",
              "minimum": 0,
              "maximum": 10,
              "default": 3
            },
            "initial_delay": {
              "type": "number",
              "title": "Initial Delay",
              "description": "Initial delay in seconds before first retry (default: 1.0)",
              "exclusiveMinimum": 0,
              "default": 1.0
            },
            "backoff": {
              "type": "number",
              "title": "Backoff Multiplier",
              "description": "Multiplier for delay increase on each retry (default: 2.0)",
              "minimum": 1.0,
              "default": 2.0
            }
          },
          "additionalProperties": false
        },
        "continue_on_failure": {
          "type": "boolean",
          "title": "Continue on Failure",
          "description": "Whether to continue workflow execution if this step fails",
          "default": false
        },
        "constraints": {
          "$ref": "#/definitions/AgentConstraints",
          "description": "Optional tool constraints for this agent step"
        },
        "condition": {
          "$ref": "#/definitions/Condition",
          "description": "Optional condition controlling step execution"
        }
      },
      "additionalProperties": false
    },
    "Condition": {
      "type": "object",
      "title": "Conditional Execution",
      "description": "Conditions that control whether a step should execute, be skipped, or fail with error. Evaluation order: fail_if → skip_if → if_condition",
      "properties": {
        "if_condition": {
          "type": "string",
          "title": "If Condition",
          "description": "Expression that must evaluate to True for step to execute"
        },
        "skip_if": {
          "type": "string",
          "title": "Skip If",
          "description": "Expression that causes step to be skipped if True"
        },
        "fail_if": {
          "type": "string",
          "title": "Fail If",
          "description": "Expression that causes step to fail with error if True (precondition validation)"
        },
        "fail_message": {
          "type": "string",
          "title": "Fail Message",
          "description": "Custom error message when fail_if condition is met"
        }
      },
      "additionalProperties": false
    },
    "AgentConstraints": {
      "type": "object",
      "title": "Agent Constraints",
      "description": "Tool permissions for agent execution",
      "properties": {
        "allowed_tools": {
          "type": "array",
          "title": "Allowed Tools",
          "description": "List of tools explicitly allowed for the agent",
          "items": {
            "type": "string",
            "enum": [
              "read",
              "edit",
              "write",
              "git_operations",
              "run_linters",
              "run_pytest"
            ]
          }
        },
        "denied_tools": {
          "type": "array",
          "title": "Denied Tools",
          "description": "List of tools explicitly denied for the agent",
          "items": {
            "type": "string"
          },
          "default": ["bash"]
        }
      },
      "additionalProperties": false
    },
    "WorkflowStep": {
      "type": "object",
      "title": "Workflow Reference Step",
      "description": "Step that references and inlines another workflow definition",
      "required": ["type", "name", "workflow_name"],
      "properties": {
        "type": {
          "type": "string",
          "const": "workflow",
          "description": "Step type identifier for workflow reference"
        },
        "name": {
          "type": "string",
          "title": "Step Name",
          "description": "Human-readable name for the step",
          "minLength": 1
        },
        "workflow_name": {
          "type": "string",
          "title": "Workflow Name",
          "description": "Name of the workflow definition to inline",
          "minLength": 1,
          "pattern": "^[a-zA-Z0-9_-]+$"
        }
      },
      "additionalProperties": false
    }
  }
}
