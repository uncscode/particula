name: opencode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  opencode:
    if: |
      startsWith(github.event.comment.body, '/oc') ||
      contains(github.event.comment.body, '\n/oc') ||
      startsWith(github.event.comment.body, '/opencode') ||
      contains(github.event.comment.body, '\n/opencode')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read
    steps:
      - name: Check if user is a maintainer
        id: check_permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            const allowedPermissions = ['admin', 'maintain', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              core.setFailed(`User ${context.actor} does not have maintainer permissions. Required: admin, maintain, or write. Current: ${permission.permission}`);
            }

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run opencode
        uses: sst/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        with:
          model: opencode/claude-haiku-4-5